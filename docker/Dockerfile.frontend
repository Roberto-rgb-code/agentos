# ============================================
# STAGE 1: Build frontend
# ============================================
FROM node:20-alpine AS builder

WORKDIR /app

# Copiar archivos de dependencias
COPY frontend/package.json frontend/yarn.lock* ./

# Instalar dependencias
RUN yarn install --network-timeout 100000 && yarn cache clean

# Copiar código del frontend
COPY frontend/ ./

# Configurar API base para producción (apunta al backend containerizado)
ENV VITE_API_BASE=/api

# Build
RUN yarn build

# Renombrar _index.html a index.html (el build de Vite genera _index.html)
RUN cd dist && if [ -f "_index.html" ]; then mv _index.html index.html; fi

# ============================================
# STAGE 2: Serve con nginx
# ============================================
FROM nginx:alpine AS production

# Copiar configuración personalizada de nginx
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# Copiar archivos buildeados
COPY --from=builder /app/dist /usr/share/nginx/html

# Exponer puerto
EXPOSE 3000

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:3000 || exit 1

CMD ["nginx", "-g", "daemon off;"]

